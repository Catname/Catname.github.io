I"Ôx<h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢</h2>

<p>æœ¬ç³»åˆ—æ˜¯ç»¼åˆäº†è‡ªå·±åœ¨å­¦ä¹ sparkè¿‡ç¨‹ä¸­çš„ç†è§£è®°å½• ï¼‹ å¯¹å‚è€ƒæ–‡ç« ä¸­çš„ä¸€äº›ç†è§£ ï¼‹ ä¸ªäººå®è·µsparkè¿‡ç¨‹ä¸­çš„ä¸€äº›å¿ƒå¾—è€Œæ¥ã€‚å†™è¿™æ ·ä¸€ä¸ªç³»åˆ—ä»…ä»…æ˜¯ä¸ºäº†æ¢³ç†ä¸ªäººå­¦ä¹ sparkçš„ç¬”è®°è®°å½•ï¼Œæ‰€ä»¥ä¸€åˆ‡ä»¥èƒ½å¤Ÿç†è§£ä¸ºä¸»ï¼Œæ²¡æœ‰å¿…è¦çš„ç»†èŠ‚å°±ä¸ä¼šè®°å½•äº†ï¼Œè€Œä¸”æ–‡ä¸­æœ‰æ—¶å€™ä¼šå‡ºç°è‹±æ–‡åŸç‰ˆæ–‡æ¡£ï¼Œåªè¦ä¸å½±å“ç†è§£ï¼Œéƒ½ä¸ç¿»è¯‘äº†ã€‚è‹¥æƒ³æ·±å…¥äº†è§£ï¼Œæœ€å¥½é˜…è¯»å‚è€ƒæ–‡ç« å’Œå®˜æ–¹æ–‡æ¡£ã€‚</p>

<p>å…¶æ¬¡ï¼Œæœ¬ç³»åˆ—æ˜¯åŸºäºç›®å‰æœ€æ–°çš„ spark 1.6.0 ç³»åˆ—å¼€å§‹çš„ï¼Œspark ç›®å‰çš„æ›´æ–°é€Ÿåº¦å¾ˆå¿«ï¼Œè®°å½•ä¸€ä¸‹ç‰ˆæœ¬å¥½è¿˜æ˜¯å¿…è¦çš„ã€‚ <br />
æœ€åï¼Œå¦‚æœå„ä½è§‰å¾—å†…å®¹æœ‰è¯¯ï¼Œæ¬¢è¿ç•™è¨€å¤‡æ³¨ï¼Œæ‰€æœ‰ç•™è¨€ 24 å°æ—¶å†…å¿…å®šå›å¤ï¼Œéå¸¸æ„Ÿè°¢ã€‚   <br />
Tips: å¦‚æœæ’å›¾çœ‹èµ·æ¥ä¸æ˜æ˜¾ï¼Œå¯ä»¥ï¼š1. æ”¾å¤§ç½‘é¡µï¼›2. æ–°æ ‡ç­¾ä¸­æ‰“å¼€å›¾ç‰‡ï¼ŒæŸ¥çœ‹åŸå›¾å“¦ã€‚</p>

<h2 id="1-åŒèŠ±é¡ºæ”¶è´¹ç‰ˆä¹‹èµ°åŠ¿é¢„æµ‹">1. åŒèŠ±é¡ºæ”¶è´¹ç‰ˆä¹‹èµ°åŠ¿é¢„æµ‹</h2>

<p>2014å¹´ååŠå¹´å¼€å§‹ï¼Œå›½å†… A è‚¡å¸‚åœºå¯è°“æ˜¯çƒ­ç«æœå¤©å•Šï¼Œè·¯ä¸Šçš„äººè°ˆçš„éƒ½æ˜¯è‚¡ç¥¨ã€‚å°å¼Ÿè™½ç„¶å°±èŒé‡‘èäº’è”ç½‘å…¬å¸ï¼Œä½†ä¹‹å‰ä»æ¥æ²¡æœ‰ä¹°è¿‡è‚¡ç¥¨ï¼Œä½†æ¯å¤©å¬ç€åˆ«äººåˆèµšäº†å‡ å¥—æˆ¿å‡ è¾†è½¦ï¼Œé‚£å«ä¸€ä¸ªå¿ƒç—’ç—’å•Šï¼Œé‚£æ„Ÿè§‰ï¼Œå°±è·Ÿä¸€ä¸ªå‡ºæµ´ç¾å¥³å’Œä½ å…±å¤„ä¸€å®¤ï¼Œä½†ä½ å´è¦æ­»å¿ä½ä¸å»æ€å¼€æµ´å·¾ä¸€æ ·ã€‚ç»ˆäºï¼Œå°å¼Ÿè¿˜æ˜¯â€çŠ¯äº†å…¨å¤©ä¸‹ç”·äººéƒ½ä¼šçŠ¯çš„é”™è¯¯â€ï¼Œè¿˜æ˜¯åœ¨ 2015.03.19 é‚£å¤©å…¥å¸‚äº†ï¼Œè¿˜è®°å¾—è‡ªå·±çš„ç¬¬ä¸€æ¬¡æ˜¯çŒ®ç»™äº†ä¸€æ”¯å« <code class="language-plaintext highlighter-rouge">å¤©å»ºé›†å›¢</code> çš„è‚¡ç¥¨ï¼Œå¥½åƒå½“å¤©è¿˜èµšäº†ä¸€ä¸¤ç™¾å—å§ï¼Œå½“æ—¶å¿ƒæƒ…é‚£å«ä¸€ä¸ªæ¿€åŠ¨ï¼Œä¸‹ç­äº†ç¬¬ä¸€æ—¶é—´å°±æ‰“ç”µè¯ç»™å¨˜äº²äº†ã€‚</p>

<p>å“¦ï¼Œä¼¼ä¹æœ‰ç‚¹æ‰¯å¾—è¿œäº†ã€‚è¨€å½’æ­£ä¼ ï¼Œå½“æ—¶è‡ªå·±ä¸ºäº†æŠ•èµ„æ›´æ–¹ä¾¿ï¼Œå°±èŠ±äº†å°†è¿‘ 300 å¤§æ´‹ä¹°äº†åŒèŠ±é¡ºçš„ level 2 ç‰ˆï¼Œé‡Œé¢æœ‰ä¸ªåŠŸèƒ½ï¼Œå«åš <code class="language-plaintext highlighter-rouge">å½¢æ€é¢„æµ‹</code>ã€‚å…·ä½“å°±æ˜¯ï¼Œæ ¹æ®æ‰€æœ‰è‚¡ç¥¨çš„å†å²è¡Œæƒ…ï¼Œçœ‹çœ‹å½“å‰è‚¡ç¥¨çš„æœªæ¥ä¸€æ®µæ—¶é—´çš„èµ°åŠ¿åˆ†å¸ƒã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæˆªå›¾ï¼š</p>

<p><img src="../images/spark-in-finance-1.jpg" alt="spark-in-finance-1.jpg" /></p>

<p>æˆªå›¾è¯´æ˜ï¼šé¢œè‰²è¶Šæ·±ï¼Œæ¦‚ç‡è¶Šå¤§ï¼ŒåŒ…æ‹¬ä¸€ç»„é¢„æµ‹çš„ k çº¿èµ°åŠ¿ã€‚å°±åƒä¸Šé¢è¯´çš„ï¼Œä¸Šé¢çš„é‚£æ”¯è‚¡ç¥¨çš„é¢„æµ‹ç»“æœæ˜¯ï¼šæœªæ¥3å‘¨æ”¶ç›Šå¤§äº 4.0% çš„æ¦‚ç‡æœ‰ 60%ã€‚amazingâ€¦</p>

<p>å…ˆä¸è¯´è¿™ä¸ªé¢„æµ‹å‡†ç¡®åº¦æœ‰å¤šé«˜ï¼Œä½†é¦–å…ˆè¿™ä¸ªæ€è·¯ä¸é”™ï¼Œè‡³å°‘å¯ä»¥ä½œä¸ºä¸€ä¸ªä¿¡å·å§ï¼»å½“ç„¶ä¸€ä¸ªç¨³å¥çš„æŠ•èµ„ç­–ç•¥è‚¯å®šä¸èƒ½ä»…ä»…ä¾èµ–äºä¸€ä¸ªä¿¡å·ï¼½</p>

<h2 id="2-å½¢æ€é€‰è‚¡">2. å½¢æ€é€‰è‚¡</h2>

<p>åŒèŠ±é¡ºè¿™ä¸ªåŠŸèƒ½ï¼Œå…¶å®ä¹ŸæŒºå®ç”¨çš„ï¼Œå› ä¸ºæœ¬èº«åœ¨è‚¡ç¥¨å¸‚åœºæŠ€æœ¯æŒ‡æ ‡è¿™ä¸ªåˆ†ç±»ä¸‹é¢ï¼Œå°±æœ‰å½¢æ€é€‰è‚¡è¿™æ ·ä¸€ç§æŒ‡æ ‡ã€‚æ¯”å¦‚è¯´ï¼Œç»å¸¸å¬è´¢ç»é¢‘é“ä¸»æŒäººè¯´çš„ <a href="http://baike.baidu.com/item/%E4%B8%89%E9%98%B3%E5%BC%80%E6%B3%B0/18751451">ä¸‰é˜³å¼€æ³°</a>ï¼Œ<a href="http://baike.baidu.com/view/1302521.htm">åœ†å¼§åº•</a> ä»€ä¹ˆçš„ã€‚</p>

<h2 id="3-æŒ‡æ•°æ—¥å†…ç›¸ä¼¼åº¦">3. æŒ‡æ•°æ—¥å†…ç›¸ä¼¼åº¦</h2>

<p>ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥å°è¯•ä¸€ä¸‹ï¼Œé€šè¿‡æŒ‡æ•°æ—¥å†…èµ°åŠ¿æ¥è¿›è¡Œå®è§‚æ‹©æ—¶: æˆ‘ä»¬åœ¨æ—©ç›˜ 11:00 æ—¶ï¼Œä½¿ç”¨å½“å¤©ä¸Šè¯æŒ‡æ•°çš„åˆ†æ—¶å›¾ï¼Œé¢„æµ‹ä¸€ä¸‹å½“å¤©èµ°åŠ¿æƒ…å†µã€‚</p>

<p>åŸç†å¦‚ä¸‹ï¼šä½¿ç”¨ä¸Šè¯æŒ‡æ•°å†å²åˆ†æ—¶æ•°æ®ï¼Œè®¡ç®—å†å²ä¸Šæ¯å¤© 09:30 åˆ° 11:00 çš„åˆ†æ—¶æ®µèµ°åŠ¿ä¸ä»Šå¤©æ—©ç›˜ 09:30 åˆ° 11:00 èµ°åŠ¿çš„ç›¸ä¼¼åº¦ã€‚æˆ‘ä»¬è®¤ä¸ºï¼Œç›¸ä¼¼åº¦è¶Šé«˜ï¼Œåˆ™ä»Šæ—¥ 11:00 åˆ° 15:00 èµ°åŠ¿å’Œ 15:00 çš„æ”¶ç›˜æ¶¨è·Œï¼Œä¸å†å²å½“æ—¥çš„èµ°åŠ¿å’Œæ”¶ç›˜æ¶¨è·Œæœ‰è¾ƒå¤§çš„ç›¸ä¼¼åº¦ã€‚</p>

<p>ç»“æœé¢„è§ˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºå“¦ï¼š</p>

<p><img src="../images/spark-in-finance-2.jpg" alt="spark-in-finance-2.jpg" /></p>

<h2 id="4-spark-å®ç°æŒ‡æ•°æ—¥å†…ç›¸ä¼¼åº¦">4. spark å®ç°æŒ‡æ•°æ—¥å†…ç›¸ä¼¼åº¦</h2>

<p>åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿç”¨ç¬¬ä¸‰ç¯‡ <a href="../spark-programming-model">ã€ Spark ã€3. spark ç¼–ç¨‹æ¨¡å¼ </a> è®²åˆ°çš„ä¸‰ä¸ªæ­¥éª¤æ¥å®ç°è¿™ä¸ªç®€å•çš„ï¼Œä½†æœ‰å®è·µæ„ä¹‰çš„ spark åº”ç”¨ç¨‹åºã€‚</p>

<p>å¤‡æ³¨ï¼šä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘æŠŠè¿™ä¸ªä¾‹å­ç²¾ç®€è¿‡äº†ï¼Œåªç”¨ä¸Šè¯æŒ‡æ•° 6 å¹´çš„åˆ†é’Ÿçº¿æ•°æ®ï¼Œå¯¹åº”çš„ç›¸ä¼¼åº¦ç®—æ³•ä¹Ÿæ˜¯é‡‡ç”¨æœ€ç®€å•çš„ç®—æ³•ã€‚ä½†æ˜¯ä¸å½±å“å¯¹æ•´ä¸ªåº”ç”¨æ¡†æ¶çš„ç†è§£å’Œæ‰©å±•ã€‚</p>

<h3 id="41-åŠ è½½æ•°æ®é›†">4.1 åŠ è½½æ•°æ®é›†</h3>

<p>æœ¬æ–‡ç”¨åˆ°çš„æ•°æ®é›†å·²ç»ä¸Šä¼ åˆ°ç™¾åº¦äº‘äº†ï¼Œä¸Šä¼ æ–‡ä»¶æ˜¯ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼Œè§£å‹ç¼©åæŠŠæ•´ä¸ªæ–‡ä»¶å¤¹ä¸Šä¼ åˆ° hadoop ä¸Šå°±è¡Œäº†ï¼Œæ–‡ä»¶å¤¹é‡Œæœ‰ 1505 ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åè¡¨ç¤ºä¸Šè¯æŒ‡æ•°æŸæ—¥çš„åˆ†é’Ÿçº¿è¡Œæƒ…ï¼Œæ–‡ä»¶å†…å®¹å³ä¸ºå†å²å½“æ—¥åˆ†é’Ÿçº¿è¡Œæƒ…ï¼š</p>

<p><img src="../images/spark-in-finance-3.jpg" alt="spark-in-finance-3.jpg" /></p>

<p>ä¸‹è½½é“¾æ¥ï¼š<a href="http://pan.baidu.com/s/1jIvW4mU">minute_bar.zip on baidu</a></p>

<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆåˆ›å»º SparkContextï¼Œç„¶ååŠ è½½å­˜æ”¾åœ¨ hdfs ä¸Šçš„æ•°æ®ã€‚</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">### åˆ›å»º sc
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">sc</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">SparkContext</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">sc_conf</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">SparkContext</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">sc_conf</span><span class="p">)</span>

<span class="c1">### åŠ è½½ hdfs ä¸Šçš„æ•°æ®
</span><span class="n">url</span> <span class="o">=</span> <span class="s">'hdfs://10.21.208.21:8020/user/mercury/minute_bar'</span>
<span class="n">rdd_mkt_data</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">wholeTextFiles</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">minPartitions</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span> \
                 <span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">'index_minute_bar'</span><span class="p">)</span> \
                 <span class="p">.</span><span class="n">cache</span><span class="p">()</span></code></pre></figure>

<h3 id="42-å¤„ç†æ•°æ®">4.2 å¤„ç†æ•°æ®</h3>

<ul>
  <li>æŒ‡å®šè¦é¢„æµ‹çš„åˆ†é’Ÿçº¿</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">### UDF å‡½æ•°ï¼Œä» rdd_mkt_data è·å–æŸæ—¥å†å²åˆ†é’Ÿçº¿è¡Œæƒ…æ•°æ®
</span><span class="k">def</span> <span class="nf">minute_bar_index</span><span class="p">(</span><span class="n">line_id</span><span class="p">):</span>
    <span class="n">line_data</span> <span class="o">=</span> <span class="n">rdd_mkt_data</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">line_id</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">line</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'barTime'</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span>

<span class="c1">### æŒ‡å®šæƒ³è¦é¢„æµ‹çš„çº¿çš„ idï¼Œè¿™é‡Œæˆ‘ä»¬é¢„æµ‹ä¸Šè¯æŒ‡æ•° 2016.03.17 çš„åˆ†é’Ÿçº¿
</span><span class="n">target_line</span> <span class="o">=</span> <span class="s">'000001.ZICN-20160317'</span>
<span class="c1">### æŒ‡å®šç”¨äºè®¡ç®—ç›¸ä¼¼åº¦çš„åˆ†é’Ÿçº¿é•¿åº¦ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ 90 ä¸ªåˆ†é’Ÿ barï¼Œ
### å³å¼€ç›˜ 09:30 åˆ° 11:00 çš„åˆ†é’Ÿçº¿
</span><span class="n">minute_bar_length</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">minute_bar_length_share</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">minute_bar_length</span><span class="p">)</span>
<span class="n">target_line_mkt_data</span> <span class="o">=</span> <span class="n">minute_bar_index</span><span class="p">(</span><span class="n">target_line</span><span class="p">)</span>
<span class="n">target_line_share</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">target_line_mkt_data</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>è®¡ç®—ç›¸ä¼¼åº¦</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">### ç›¸ä¼¼åº¦è®¡ç®—å‡½æ•°
</span><span class="k">def</span> <span class="nf">cal_similarity</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="s">"""è®¡ç®—ç›¸ä¼¼åº¦
    """</span>
    <span class="c1">### ä½¿ç”¨ sklearnï¼Œpandas æ¥ç®€åŒ–è®¡ç®—æµç¨‹
</span>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
    <span class="kn">import</span> <span class="nn">sklearn.preprocessing</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">sklearn</span><span class="p">.</span><span class="n">preprocessing</span><span class="p">.</span><span class="n">MinMaxScaler</span><span class="p">()</span>
    
    <span class="c1">### é€šè¿‡å¹¿æ’­å˜é‡è·å–é¢„æµ‹çš„ç›®æ ‡çº¿å’Œå‡†å¤‡ç”¨æ¥é¢„æµ‹çš„åˆ†é’Ÿçº¿é•¿åº¦
</span>    <span class="n">minute_length</span> <span class="o">=</span> <span class="n">minute_bar_length_share</span><span class="p">.</span><span class="n">value</span>
    <span class="n">target_line</span> <span class="o">=</span> <span class="n">target_line_share</span><span class="p">.</span><span class="n">value</span>
    
    <span class="c1">### å‚æ•° line çš„æ ¼å¼æ˜¯ï¼š (line_id, line_data)
</span>    <span class="n">line_id</span><span class="p">,</span> <span class="n">line_data</span> <span class="o">=</span> <span class="n">line</span>
    
    <span class="c1">### è·å– pandas dataframe æ ¼å¼çš„æŸæ—¥åˆ†é’Ÿçº¿è¡Œæƒ…
</span>    <span class="n">ticker</span><span class="p">,</span> <span class="n">tradeDate</span> <span class="o">=</span> <span class="n">line_id</span><span class="p">[</span><span class="o">-</span><span class="mi">25</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'-'</span><span class="p">)</span>
    <span class="n">line_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line_data</span><span class="p">))</span>
    <span class="n">line_data</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'barTime'</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="c1">### æ¯å¤©æœ‰ 240 æ¡åˆ†é’Ÿçº¿çš„ barï¼Œæˆ‘ä»¬ç”¨ å‰ minute_length æ¥è®¡ç®—ç›¸ä¼¼åº¦
</span>    <span class="n">line1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target_line</span><span class="p">.</span><span class="n">ratio</span><span class="p">)[:</span> <span class="n">minute_length</span><span class="p">]</span>
    <span class="n">line2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line_data</span><span class="p">.</span><span class="n">ratio</span><span class="p">)[:</span> <span class="n">minute_length</span><span class="p">]</span>
    
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">()</span>    
    <span class="n">tmp</span><span class="p">[</span><span class="s">'first'</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="s">'second'</span><span class="p">]</span> <span class="o">=</span> <span class="n">line1</span><span class="p">,</span> <span class="n">line2</span>
    <span class="n">tmp</span><span class="p">[</span><span class="s">'diff'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s">'first'</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">[</span><span class="s">'second'</span><span class="p">]</span>
    <span class="n">diff_square</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s">'diff'</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1">### è¿”å›æ ¼å¼ï¼š(åˆ†é’Ÿçº¿idï¼Œè¯¥åˆ†é’Ÿçº¿å’Œç›®æ ‡çº¿å‰ minute_length ä¸ªé•¿åº¦çš„ç›¸ä¼¼åº¦)
</span>    <span class="k">return</span> <span class="p">(</span><span class="n">line_id</span><span class="p">[</span><span class="o">-</span><span class="mi">25</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">],</span> <span class="nb">round</span><span class="p">(</span><span class="n">diff_square</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>                


<span class="c1">### spark ç›¸ä¼¼åº¦è®¡ç®—ä»£ç 
</span><span class="n">rdd_similarity</span> <span class="o">=</span> <span class="n">rdd_mkt_data</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">cal_similarity</span><span class="p">)</span>\
                             <span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">'rdd_similarity'</span><span class="p">)</span> \
                             <span class="p">.</span><span class="n">cache</span><span class="p">()</span></code></pre></figure>

<h3 id="43-ç»“æœå±•ç¤º">4.3 ç»“æœå±•ç¤º</h3>

<ul>
  <li>è·å–ç›¸ä¼¼åº¦é«˜çš„åˆ†é’Ÿçº¿</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">### UDFï¼Œä» rdd_mkt_data é‡Œè·å–æŒ‡å®šçš„å¤šæ—¥åˆ†é’Ÿçº¿æ•°æ®
</span><span class="k">def</span> <span class="nf">get_similary_line</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">):</span>
    <span class="c1">### è·å–åŸå§‹ç›¸ä¼¼çš„åˆ†é’Ÿçº¿æ•°æ®
</span>    <span class="n">rdd_lines</span> <span class="o">=</span> <span class="n">rdd_mkt_data</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">25</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">]</span>
    <span class="p">).</span><span class="n">collect</span><span class="p">()</span>
    <span class="c1">### æŠŠåŸå§‹åˆ†é’Ÿçº¿æ•°æ®è½¬æˆ pandas dataframe æ ¼å¼
</span>    <span class="n">similar_line</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">25</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]:</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> 
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rdd_lines</span>
    <span class="p">}</span>
    <span class="n">similar_line</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">similar_line</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'barTime'</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">similar_line</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">similar_line</span>

<span class="c1">### è·å–ç›¸ä¼¼åº¦æœ€é«˜çš„30æ—¥åˆ†é’Ÿçº¿
</span>
<span class="n">similarity_data</span> <span class="o">=</span> <span class="n">rdd_similarity</span><span class="p">.</span><span class="n">takeOrdered</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">similar_line</span> <span class="o">=</span> <span class="n">get_similary_line</span><span class="p">(</span><span class="n">similarity_data</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>æ ¹æ®ç›¸ä¼¼åˆ†é’Ÿçº¿ç»˜åˆ¶é¢„æµ‹å›¾</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">draw_similarity</span><span class="p">(</span><span class="n">target_line</span><span class="p">,</span> <span class="n">minute_bar_length</span><span class="p">,</span> <span class="n">similarity_data</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">similarity_data</span><span class="p">:</span>
        <span class="n">line_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">line_data</span> <span class="o">=</span> <span class="n">similar_line</span><span class="p">[</span><span class="n">line_id</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="n">line_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_data</span><span class="p">.</span><span class="n">ratio</span>
        <span class="k">if</span> <span class="s">'minute'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span> <span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s">'minute'</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_data</span><span class="p">.</span><span class="n">barTime</span>  
        <span class="n">columns</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_id</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="s">'fitting'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">columns</span><span class="p">].</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="s">'target_line'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_line_mkt_data</span><span class="p">.</span><span class="n">ratio</span>
    
    <span class="c1">### plot 
</span>    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'minute'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> 
                  <span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">u</span><span class="s">'Minute Bar Prediction'</span><span class="p">)</span>
    <span class="n">res</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s">'target_line'</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">'.b'</span><span class="p">)</span>
    <span class="n">res</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s">'fitting'</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">'-y'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">minute_bar_length</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> 
              <span class="n">linestyles</span><span class="o">=</span><span class="s">'dashed'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_axis_bgcolor</span><span class="p">(</span><span class="s">'white'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s">'y'</span><span class="p">)</span>
    
    <span class="c1">### plot area
</span>    <span class="n">avg_line</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">'fitting'</span><span class="p">]</span>
    <span class="n">avg_line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">avg_line</span><span class="p">)[</span><span class="n">minute_bar_length</span> <span class="p">:</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">predict_line</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>
        <span class="n">predict_line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predict_line</span><span class="p">)[</span><span class="n">minute_bar_length</span> <span class="p">:</span> <span class="p">]</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">minute_bar_length</span><span class="p">,</span> <span class="mi">241</span><span class="p">),</span> <span class="n">avg_line</span><span class="p">,</span> 
                        <span class="n">predict_line</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'r'</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">ax</span>

<span class="n">res</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">draw_similarity</span><span class="p">(</span><span class="n">target_line</span><span class="p">,</span> <span class="n">minute_bar_length</span><span class="p">,</span> <span class="n">similarity_data</span><span class="p">)</span></code></pre></figure>

<p><img src="../images/spark-in-finance-2.jpg" alt="spark-in-finance-2.jpg" /></p>

<h2 id="5-next">5. Next</h2>

<p>è¿™ä¸ªä¾‹å­è¿˜ç®— ok å§ï¼Œå¯æ˜¯æˆ‘æ¯å¤©éƒ½åº”ç”¨çš„æŠ•èµ„ç­–ç•¥çš„ä¸€éƒ¨åˆ†å•Šï¼Œå·²ç»ä¸‹è¡€æœ¬äº†ï¼Œå„ä½è¿˜ä¸æ‰“èµæ‰“èµå—ï¼Ÿä¸€è½¬çœ¼ spark å·²ç»å¿«è¦æœ‰åç¯‡ blog äº†ï¼Œæœ¬æ¥åŸè®¡åˆ’ç¬¬ä¹ç¯‡æ˜¯æ€»ç»“ä¸€äº› spark æ€§èƒ½ä¼˜åŒ–çš„ tips çš„ã€‚å¯æ˜¯å‰å‡ å¤©ä¸€ä¸ªæœ‹å‹çªç„¶é—®æˆ‘æ˜¯æ€ä¹ˆå¼€å‘ spark åº”ç”¨ç¨‹åºçš„ã€‚æˆ‘æ‰æç„¶å¤§æ‚Ÿï¼Œä¸€ä¸‹å­å†™äº†è¿™ä¹ˆå¤šç¯‡ï¼Œéƒ½æ²¡æœ‰æŠŠæ­å»ºå¼€å‘ç¯å¢ƒçš„ç»éªŒå†™å‡ºæ¥çš„å‘¢ã€‚</p>

<p>ä¸‹ä¸€ç¯‡æˆ‘å°±æ€»ç»“ä¸€ä¸‹è‡ªå·±æ€ä¹ˆæ­å»ºçš„ä¸€ä¸ª ipython + spark çš„å¼€å‘ç¯å¢ƒï¼›ä¸ç®¡å„ä½æœ‰æ²¡æœ‰ç”¨è¿‡ ipython [notebook]ï¼Œæˆ‘éƒ½å¼ºçƒˆæ¨èä½¿ç”¨ï¼Œä½¿ç”¨å®ƒèƒ½æ‰“æ‰“æé«˜ä½ çš„å¼€å‘æ•ˆç‡å’Œå¼€å‘ä½“éªŒï¼Œä½ ä¸€å®šä¼šçˆ±ä¸Šä»–çš„ï¼Œç›¸ä¿¡æˆ‘ã€‚</p>

<h2 id="6-æ‰“å¼€å¾®ä¿¡æ‰«ä¸€æ‰«ç‚¹ä¸€ç‚¹æ£’æ£’çš„_">6. æ‰“å¼€å¾®ä¿¡ï¼Œæ‰«ä¸€æ‰«ï¼Œç‚¹ä¸€ç‚¹ï¼Œæ£’æ£’çš„ï¼Œ^_^</h2>

<p><img src="../images/wechat_pay_6-6.png" alt="wechat_pay_6-6.png" /></p>

<h2 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h2>

<ul>
  <li><a href="http://spark.apache.org/docs/latest/sql-programming-guide.html#dataframes">Spark SQL, DataFrames and Datasets Guide</a></li>
  <li><a href="https://databricks.com/blog/2015/02/17/introducing-dataframes-in-spark-for-large-scale-data-science.html">Introducing DataFrames in Spark for Large Scale Data Science</a></li>
  <li><a href="https://forums.databricks.com/questions/7257/from-webinar-spark-dataframes-what-is-the-differen-1.html">From Webinar Apache Spark 1.5: What is the difference between a DataFrame and a RDD?</a></li>
  <li><a href="http://www.infoq.com/cn/articles/apache-spark-sql">ç”¨Apache Sparkè¿›è¡Œå¤§æ•°æ®å¤„ç†â€”â€”ç¬¬äºŒéƒ¨åˆ†ï¼šSpark SQL</a></li>
  <li><a href="https://databricks.com/blog/2015/02/02/an-introduction-to-json-support-in-spark-sql.html">An introduction to JSON support in Spark SQL</a></li>
  <li><a href="http://www.csdn.net/article/2015-02-18/2823997">Sparkæ–°å¹´ç¦éŸ³ï¼šä¸€ä¸ªç”¨äºå¤§è§„æ¨¡æ•°æ®ç§‘å­¦çš„APIâ€”â€”DataFrame</a></li>
  <li><a href="https://databricks.com/blog/2015/02/02/an-introduction-to-json-support-in-spark-sql.html">An introduction to JSON support in Spark SQL</a></li>
</ul>

<h2 id="æœ¬ç³»åˆ—æ–‡ç« é“¾æ¥">æœ¬ç³»åˆ—æ–‡ç« é“¾æ¥</h2>

<ul>
  <li><a href="http://litaotao.github.io/introduction-to-spark">ã€ Spark ã€1. spark ç®€ä»‹ </a></li>
  <li><a href="http://litaotao.github.io/spark-questions-concepts">ã€ Spark ã€2. spark åŸºæœ¬æ¦‚å¿µè§£æ </a></li>
  <li><a href="http://litaotao.github.io/spark-programming-model">ã€ Spark ã€3. spark ç¼–ç¨‹æ¨¡å¼ </a></li>
  <li><a href="http://litaotao.github.io/spark-what-is-rdd">ã€ Spark ã€4. spark ä¹‹ RDD </a></li>
  <li><a href="http://litaotao.github.io/spark-resouces-blogs-paper">ã€ Spark ã€5. è¿™äº›å¹´ï¼Œä½ ä¸èƒ½é”™è¿‡çš„ spark å­¦ä¹ èµ„æº </a></li>
  <li><a href="http://litaotao.github.io/deep-into-spark-exection-model">ã€ Spark ã€6. æ·±å…¥ç ”ç©¶ spark è¿è¡ŒåŸç†ä¹‹ job, stage, task</a></li>
  <li><a href="http://litaotao.github.io/spark-dataframe-introduction">ã€ Spark ã€7. ä½¿ç”¨ Spark DataFrame è¿›è¡Œå¤§æ•°æ®åˆ†æ</a></li>
  <li><a href="http://litaotao.github.io/spark-in-finance-and-investing">ã€ Spark ã€8. å®æˆ˜æ¡ˆä¾‹ ï½œ Spark åœ¨é‡‘èé¢†åŸŸçš„åº”ç”¨ ï½œ æ—¥å†…èµ°åŠ¿é¢„æµ‹</a></li>
  <li><a href="http://litaotao.github.io/ipython-notebook-spark">ã€ Spark ã€9. æ­å»º IPython + Notebook + Spark å¼€å‘ç¯å¢ƒ</a></li>
  <li><a href="http://litaotao.github.io/boost-spark-application-performance">ã€ Spark ã€10. spark åº”ç”¨ç¨‹åºæ€§èƒ½ä¼˜åŒ–ï½œ12 ä¸ªä¼˜åŒ–æ–¹æ³•</a></li>
</ul>
:ET