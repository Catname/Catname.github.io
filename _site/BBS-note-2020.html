<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>BBS 开发记录 | 雄猫的自由空间</title>
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css" type="text/css" />
  <link rel="stylesheet" href="/css/default.css" type="text/css" />
  <link rel="stylesheet" href="/css/desktop.css" type="text/css" />
  <link rel="stylesheet" href="/css/mobile.css" type="text/css" />
  <link rel="shortcut icon" href="/css/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="/css/favicon.ico" mce_href="/favicon.ico" type="image/x-icon">
  <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
  <script src="/js/jquery-1.11.0.min.js" type="text/javascript"></script>
  <script src="/js/jquery-migrate-1.2.1.js" type="text/javascript"></script>
  <script src="/js/jquery.transit.min.js" type="text/javascript"></script>
  <script src="/js/common.js" type="text/javascript"></script>

<body>
  <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
  html {
    background: #333333;
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;
  }
  @media screen and (max-width: 750px){
    body { background: rgba(255, 255, 255, 0.9); }
  }
</style>

<div id="content" class="post" style="margin-top: 20px;">
  <div id="avatar" class="avatar circle" data-in-right="false" style="width: 150px; height: 150px; position: fixed; top: 40px; z-index: 99; opacity: 0;">
    <div class="center" style="margin-top: 4px; height: 142px; width: 142px; border-radius: 71px; background-image: url('../images/2.jpg');"></div>
  </div>

  <div class="entry" style="position: relative;">
    <h1 class="entry-title"><a href="/BBS-note-2020" title="BBS 开发记录">BBS 开发记录</a></h1>

    <p class="entry-date">2020-09-25 
        <span class="lastModified" style="display: none;" data-source="_posts/note/2020-09-25-BBS-note-2020.md">最后更新时间: 
        </span>
    </p>


    <h1 id="evabbs">EvaBBS</h1>
<hr />
<h2 id="git-工作流">Git 工作流</h2>
<h3 id="初始化">初始化</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git init
git add <span class="nt">-A</span>
git commit <span class="nt">-m</span> <span class="s1">'reason'</span>
git remote add origin git@github.com:&lt;username&gt;/项目名.git
git push <span class="nt">-u</span> origin 默认分支名
</code></pre></div></div>

<h3 id="日常">日常</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout <span class="nb">.</span> （放弃操作）
git checkout <span class="nt">-b</span> 分支名
git add <span class="nt">-A</span> 或 git add filename
git commit <span class="nt">-m</span> <span class="s1">'reason'</span>
git push
</code></pre></div></div>

<hr />
<h2 id="前端工作流">前端工作流</h2>
<h3 id="集成-bootstrap">集成 Bootstrap</h3>
<ul>
  <li>Composer 安装相应的文件</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require laravel/ui:^2.0 <span class="nt">--dev</span>

php artisan ui bootstrap

yarn <span class="nb">install

</span>npm run watch-poll （监听文件变化并编译） 或 npm run dev （编译一次）
</code></pre></div></div>

<h3 id="修改样式">修改样式</h3>
<p>修改 <code class="language-plaintext highlighter-rouge">resources/sass/app.scss</code> 后，运行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run watch-poll （监听文件变化并编译） 或 npm run dev （编译一次）
</code></pre></div></div>

<h3 id="防止浏览器缓存问题">防止浏览器缓存问题</h3>
<p>修改 <code class="language-plaintext highlighter-rouge">webpack.mix.js</code></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mix</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">laravel-mix</span><span class="dl">'</span><span class="p">);</span>
 <span class="nx">mix</span><span class="p">.</span><span class="nx">js</span><span class="p">(</span><span class="dl">'</span><span class="s1">resources/js/app.js</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">public/js</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">sass</span><span class="p">(</span><span class="dl">'</span><span class="s1">resources/sass/app.scss</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">public/css</span><span class="dl">'</span><span class="p">).</span><span class="nx">version</span><span class="p">();</span>
</code></pre></div></div>

<p>修改 <code class="language-plaintext highlighter-rouge">resources/views/layouts/app.blade.php</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Styles --&gt;</span>
<span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">""</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<h3 id="字体图标">字体图标</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn add @fortawesome/fontawesome-free
</code></pre></div></div>

<p>在样式中载入 <code class="language-plaintext highlighter-rouge">resources/sass/app.scss</code></p>

<div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Fontawesome</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/fontawesome'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/regular'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/solid'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/brands'</span><span class="p">;</span>
</code></pre></div></div>

<p>然后编译</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run watch-poll （监听文件变化并编译） 或 npm run dev （编译一次）
</code></pre></div></div>

<hr />
<h2 id="用户认证">用户认证</h2>
<h3 id="laravel-自带的用户认证脚手架">Laravel 自带的用户认证脚手架</h3>
<p>执行认证脚手架命令，生成代码：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan ui:auth
</code></pre></div></div>

<p>它会自动生成用户认证路由：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Auth</span><span class="o">::</span><span class="nf">routes</span><span class="p">();</span>
</code></pre></div></div>

<p>同时 <code class="language-plaintext highlighter-rouge">ui:auth</code> 命令生成了 <code class="language-plaintext highlighter-rouge">resources/views/auth</code> 下几个文件：</p>

<table>
  <thead>
    <tr>
      <th>视图名称</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>register.blade.php</td>
      <td>注册页面视图</td>
    </tr>
    <tr>
      <td>login.blade.php</td>
      <td>登录页面视图</td>
    </tr>
    <tr>
      <td>verify.blade.php</td>
      <td>邮箱认证视图</td>
    </tr>
    <tr>
      <td>passwords/email.blade.php</td>
      <td>提交邮箱发送邮件的视图</td>
    </tr>
    <tr>
      <td>passwords/reset.blade.php</td>
      <td>重置密码的页面视图</td>
    </tr>
  </tbody>
</table>

<h3 id="本地化">本地化</h3>
<p>安装语言包 Laravel Lang，此项目支持了52个国家的语言</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require <span class="s2">"overtrue/laravel-lang:~3.0"</span>
</code></pre></div></div>

<p>将 <code class="language-plaintext highlighter-rouge">config/app.php</code> 中的下一行</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Illuminate\Translation\TranslationServiceProvider</span><span class="o">::</span><span class="n">class</span><span class="p">,</span>
</code></pre></div></div>

<p>替换为：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Overtrue\LaravelLang\TranslationServiceProvider</span><span class="o">::</span><span class="n">class</span><span class="p">,</span>
</code></pre></div></div>

<h3 id="blade-模版中判断登录状态">Blade 模版中判断登录状态</h3>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@guest
    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">""</span><span class="nt">&gt;</span>登录<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">""</span><span class="nt">&gt;</span>注册<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
@else
    ...
@endguest
</code></pre></div></div>

<h3 id="验证码">验证码</h3>
<h4 id="安装第三方扩展包-mewscaptcha-作为基础来实现验证码功能">安装第三方扩展包 mews/captcha 作为基础来实现验证码功能。</h4>
<p>终端中执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require <span class="s2">"mews/captcha:~3.0"</span>

php artisan vendor:publish <span class="nt">--provider</span><span class="o">=</span><span class="s1">'Mews\Captcha\CaptchaServiceProvider'</span> 
</code></pre></div></div>

<h4 id="页面嵌入">页面嵌入</h4>
<h5 id="前端展示">前端展示</h5>
<p>终端中执行：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;img</span> <span class="na">class=</span><span class="s">"thumbnail captcha mt-3 mb-2"</span> 
     <span class="na">src=</span><span class="s">""</span> 
     <span class="na">onclick=</span><span class="s">"this.src='/captcha/flat?'+Math.random()"</span> 
     <span class="na">title=</span><span class="s">"点击图片重新获取验证码"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<h5 id="后端验证">后端验证</h5>
<p>实现原理：利用了Laravel 表单验证器提供的 <a href="https://learnku.com/docs/laravel/7.x/validation/7467#custom-validation-rules">自定义表单验证规则</a> 功能</p>

<p>在注册控制器中添加上表单验证规则
<code class="language-plaintext highlighter-rouge">app/Http/Controllers/Auth/RegisterController.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">function</span> <span class="n">validator</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nc">Validator</span><span class="o">::</span><span class="nf">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
            <span class="mf">...</span>
            <span class="s1">'captcha'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'required'</span><span class="p">,</span> <span class="s1">'captcha'</span><span class="p">],</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="s1">'captcha.required'</span> <span class="o">=&gt;</span> <span class="s1">'验证码不能为空'</span><span class="p">,</span>
            <span class="s1">'captcha.captcha'</span> <span class="o">=&gt;</span> <span class="s1">'请输入正确的验证码'</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="邮箱认证">邮箱认证</h3>
<h4 id="邮箱认证工作机制一般分两步">『邮箱认证』工作机制一般分两步</h4>
<ol>
  <li>发送认证邮件 —— 将附带认证信息的『认证链接』发送到用户邮箱里；</li>
  <li>检测认证链接 —— 用户打开邮件，点击认证链接进入网站，程序检测 URL 中认证参数的合法性，并渲染对应的页面。
    <h4 id="认证过程思路">认证过程思路</h4>
  </li>
  <li>用户注册成功后，给用户发送一个认证邮件；</li>
  <li>用户登录状态下，如邮箱未认证，重定向到提醒验证邮箱的页面中。
    <h4 id="实现原理">实现原理</h4>
    <ul>
      <li>使用 Laravel 默认自带<strong>邮箱认证</strong>功能</li>
      <li>用户在提交注册表单后，Laravel 会通过事件系统触发 Registered 事件，通过监听此事件，在触发时发送用户认证邮件。</li>
      <li>使用自定义中间件过滤用户所有请求，将未认证用户强制跳转到认证提示页面。</li>
    </ul>
  </li>
</ol>

<hr />
<h2 id="用户授权">用户授权</h2>
<h3 id="限制游客访问">限制游客访问</h3>
<h4 id="auth-中间件">Auth 中间件</h4>
<p>除了 show ，其他都需要登录后才能访问</p>

<p><code class="language-plaintext highlighter-rouge">UsersController.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">middleware</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'except'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'show'</span><span class="p">]]);</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="只能编辑自己的资料">只能编辑自己的资料</h3>
<h4 id="policy-授权策略类">Policy 授权策略类</h4>
<p>终端中执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan make:policy UserPolicy
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">app/Policies/UserPolicy.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">update</span><span class="p">(</span><span class="kt">User</span> <span class="nv">$currentUser</span><span class="p">,</span> <span class="kt">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$currentUser</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">===</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>在需要授权的地方使用</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">authorize</span><span class="p">(</span><span class="s1">'update'</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="blade-模版根据权限显示内容">Blade 模版根据权限显示内容</h3>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@can('update', $topic)
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"operate"</span><span class="nt">&gt;</span>
       ...
    <span class="nt">&lt;/div&gt;</span>
@endcan
</code></pre></div></div>

<hr />
<h2 id="表单验证">表单验证</h2>
<h3 id="表单请求验证-formrequest"><a href="https://learnku.com/docs/laravel/7.x/validation/7467">表单请求验证</a> （FormRequest）</h3>
<p>用来验证用户提交的数据是否合规</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan make:request UserRequest
</code></pre></div></div>

<p>常用验证规则<br />
<a href="https://learnku.com/docs/laravel/7.x/validation/7467#rule-alpha-dash">alpha_dash</a> :验证字段可能包含字母、数字，以及破折号 (-) 和下划线 ( _ )。<br />
<a href="https://learnku.com/docs/laravel/7.x/validation/7467#rule-between">between:min,max</a> :验证字段的大小必须在给定的 <code class="language-plaintext highlighter-rouge">min</code> 和 <code class="language-plaintext highlighter-rouge">max</code> 之间。字符串、数字、数组和文件的计算方式都使用 <code class="language-plaintext highlighter-rouge">size</code> 方法。<br />
<a href="https://learnku.com/docs/laravel/7.x/validation/7467#rule-confirmed">confirmed</a> :验证字段必须具有匹配字段 <code class="language-plaintext highlighter-rouge">foo_confirmation</code> 。例如，验证字段为 <code class="language-plaintext highlighter-rouge">password</code> ，输入中必须存在与之匹配的 <code class="language-plaintext highlighter-rouge">password_confirmation</code> 字段。<br />
<a href="https://learnku.com/docs/laravel/7.x/validation/7467#rule-email">email</a> :验证的字段必须符合 <code class="language-plaintext highlighter-rouge">e-mail</code> 地址格式。<br />
<a href="https://learnku.com/docs/laravel/7.x/validation/7467#rule-nullable">nullable</a> :验证字段可以为 <code class="language-plaintext highlighter-rouge">null</code>。这在验证基本数据类型时特别有用，例如可以包含空值的字符串和整数。<br />
<a href="https://learnku.com/docs/laravel/7.x/validation/7467#rule-required">required</a> :验证的字段必须存在于输入数据中，而不是空。<br />
<a href="https://learnku.com/docs/laravel/7.x/validation/7467#rule-unique">unique:table,column,except,idColumn</a> :验证字段在给定的数据库表中必须是唯一的。</p>

<hr />
<h2 id="图片上传">图片上传</h2>
<h3 id="通过-请求对象-request来获取">通过 <a href="https://learnku.com/docs/laravel/7.x/requests#retrieving-uploaded-files">请求对象</a> （Request）来获取</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">avatar</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="通过-表单请求验证-formrequest限制图片大小">通过 <a href="https://learnku.com/docs/laravel/7.x/validation/7467">表单请求验证</a> （FormRequest）限制图片大小</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="p">[</span>
           <span class="s1">'avatar'</span> <span class="o">=&gt;</span> <span class="s1">'mimes:jpeg,bmp,png,gif|dimensions:min_width=208,min_height=208'</span><span class="p">,</span>
       <span class="p">];</span>
</code></pre></div></div>

<h3 id="裁剪图像">裁剪图像</h3>
<p>图片太大会拖慢页面的加载速度。<br />
通过 Intervention/image 扩展包来处理图片裁切的逻辑</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require intervention/image

php artisan vendor:publish <span class="nt">--provider</span><span class="o">=</span><span class="s2">"Intervention</span><span class="se">\I</span><span class="s2">mage</span><span class="se">\I</span><span class="s2">mageServiceProviderLaravelRecent"</span>
</code></pre></div></div>

<hr />
<h2 id="调试用的假数据填充">调试用的假数据填充</h2>
<h3 id="以用户数据为例涉及以下几个文件">以用户数据为例，涉及以下几个文件：</h3>
<ol>
  <li>数据模型 User.php</li>
  <li>用户的数据工厂 database/factories/UserFactory.php</li>
  <li>用户的数据填充 database/seeds/UsersTableSeeder.php</li>
  <li>注册数据填充 database/seeds/DatabaseSeeder.php</li>
</ol>

<h3 id="步骤">步骤</h3>
<ol>
  <li>
    <p>定制用户数据工厂（单个用户的信息）</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$factory</span><span class="o">-&gt;</span><span class="nb">define</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Faker</span> <span class="nv">$faker</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">return</span> <span class="p">[</span>
         <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$faker</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
         <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$faker</span><span class="o">-&gt;</span><span class="nf">unique</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">safeEmail</span><span class="p">,</span>
         <span class="s1">'email_verified_at'</span> <span class="o">=&gt;</span> <span class="nf">now</span><span class="p">(),</span>
         <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi'</span><span class="p">,</span> <span class="c1">// password</span>
         <span class="s1">'remember_token'</span> <span class="o">=&gt;</span> <span class="nc">Str</span><span class="o">::</span><span class="nf">random</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
     <span class="p">];</span>
 <span class="p">});</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>完成数据填充文件（需要填充多少）</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> php artisan make:seed UsersTableSeeder
</code></pre></div>    </div>

    <p>修改 <code class="language-plaintext highlighter-rouge">database/seeds/UsersTableSeeder.php</code></p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">function</span> <span class="n">run</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="c1">// 生成数据集合</span>
     <span class="nv">$users</span> <span class="o">=</span> <span class="nf">factory</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">times</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

     <span class="c1">// 单独处理第一个用户的数据</span>
     <span class="nv">$user</span> <span class="o">=</span> <span class="nc">User</span><span class="o">::</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
     <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'tomcat'</span><span class="p">;</span>
     <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">=</span> <span class="s1">'tomcath@foxmail.com'</span><span class="p">;</span>
     <span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>注册数据填充 <code class="language-plaintext highlighter-rouge">database/seeds/DatabaseSeeder.php</code></p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">function</span> <span class="n">run</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">call</span><span class="p">(</span><span class="nc">UsersTableSeeder</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>重置数据库并填充数据</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> php artisan migrate:refresh <span class="nt">--seed</span>
</code></pre></div>    </div>
  </li>
</ol>

<hr />
<h2 id="模型关联">模型关联</h2>
<h3 id="一对一-hasone">一对一 hasOne</h3>
<h3 id="一对一反向关联-belongsto">一对一（反向关联） belongsTo</h3>
<ul>
  <li>一个 Topic 属于一个分类。</li>
  <li>一个 Topic 属于一个作者。</li>
</ul>

<h3 id="一对多-hasmany">一对多 hasMany</h3>
<ul>
  <li>一个用户拥有多个 Topic。</li>
  <li>一个用户拥有多条 评论。</li>
</ul>

<h3 id="多对多-belongstomany">多对多 belongsToMany</h3>

<hr />
<h2 id="性能优化">性能优化</h2>
<h3 id="安装-laravel-开发者工具类---laravel-debugbar">安装 Laravel 开发者工具类 - laravel-debugbar</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require <span class="s2">"barryvdh/laravel-debugbar:~3.2"</span> <span class="nt">--dev</span>

php artisan vendor:publish <span class="nt">--provider</span><span class="o">=</span><span class="s2">"Barryvdh</span><span class="se">\D</span><span class="s2">ebugbar</span><span class="se">\S</span><span class="s2">erviceProvider"</span>
</code></pre></div></div>

<p>打开 <code class="language-plaintext highlighter-rouge">config/debugbar.php</code>，将 <code class="language-plaintext highlighter-rouge">enabled</code> 的值设为：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'enabled'</span> <span class="o">=&gt;</span> <span class="nf">env</span><span class="p">(</span><span class="s1">'APP_DEBUG'</span><span class="p">,</span> <span class="kc">false</span><span class="p">),</span>
</code></pre></div></div>

<h3 id="n1-问题">N+1 问题</h3>
<h4 id="产生原因">产生原因：</h4>
<p>遍历 ORM 关联数据时，每次循环都要向数据库查询关联数据，读 30 条就要执行 30 * 2 + 1 = 61 条语句，所以称为 N+1 问题。</p>
<h4 id="解决方案">解决方案：</h4>
<p>通过 Eloquent 提供的 <a href="https://learnku.com/docs/laravel/7.x/eloquent-relationships/7500#eager-loading">预加载功能</a> 来解决此问题：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$topics</span> <span class="o">=</span> <span class="nc">Topic</span><span class="o">::</span><span class="nf">with</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="s1">'category'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">paginate</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>with() 方法提前加载了我们后面需要用到的关联属性 user 和 category，并做了缓存。</li>
  <li>后面即使是在遍历数据时使用到这两个关联属性，数据已经被预加载并缓存，因此不会再产生多余的 SQL 查询。</li>
</ul>

<hr />
<h2 id="安全漏洞">安全漏洞</h2>
<p>安全原则 <code class="language-plaintext highlighter-rouge">永远不要信任用户提交的数据。</code></p>
<h3 id="xss--cross-site-scripting--跨站脚本攻击">XSS ( Cross Site Scripting ) 跨站脚本攻击</h3>
<h4 id="攻击者在-web-页面插入-javascript-代码当用户浏览该页时代码便会执行常见操作是盗取用户-cookie">攻击者在 Web 页面插入 JavaScript 代码，当用户浏览该页时，代码便会执行，常见操作是盗取用户 Cookie。</h4>
<h4 id="避免-xss-攻击的方法">避免 XSS 攻击的方法</h4>
<ul>
  <li>对用户提交的数据进行过滤</li>
  <li>Web 网页显示时对数据进行特殊处理，一般使用 htmlspecialchars() 输出。</li>
</ul>

<p>Laravel 的 Blade 语法  会自动调用 PHP htmlspecialchars 函数来避免 XSS 攻击。但有些时候我们不得不使用 {!! !!}来原样输出数据，比如使用 WYSIWYG 编辑器时。</p>

<p>解决办法： 使用 HTMLPurifier for Laravel 对用户内容进行过滤。</p>

<p><strong>用监听器在用户数据入库前进行过滤操作</strong>：<br />
<code class="language-plaintext highlighter-rouge">app/Observers/TopicObserver.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TopicObserver</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">saving</span><span class="p">(</span><span class="kt">Topic</span> <span class="nv">$topic</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$topic</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nf">clean</span><span class="p">(</span><span class="nv">$topic</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">,</span> <span class="s1">'user_topic_body'</span><span class="p">);</span>

        <span class="nv">$topic</span><span class="o">-&gt;</span><span class="n">excerpt</span> <span class="o">=</span> <span class="nf">make_excerpt</span><span class="p">(</span><span class="nv">$topic</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="csrf-跨站请求伪造">CSRF 跨站请求伪造</h3>
<h4 id="这种攻击凭借已通过身份验证的用户身份来运行未经过授权的命令">这种攻击凭借已通过身份验证的用户身份来运行未经过授权的命令。</h4>
<h4 id="避免-csrf-攻击的方法">避免 CSRF 攻击的方法</h4>
<ul>
  <li>Laravel 会自动为每个活跃的用户的会话生成一个 CSRF「令牌」。该令牌用于验证经过身份验证的用户是否是向应用程序发出请求的用户。</li>
  <li>
    <p>在定义 HTMl 表单时，包含一个隐藏的 CSRF 标记字段。</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"/profile"</span><span class="nt">&gt;</span>
  @csrf
  ...
  <span class="nt">&lt;/form&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>X-CSRF-TOKEN （通过验证的同时，还能方便Jquery AJAX 使用）</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"csrf-token"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />
<h2 id="seo-友好的-url">SEO 友好的 URL</h2>
<h3 id="第三方-api-调用">第三方 API 调用</h3>
<h4 id="使用-guzzle-的-http-客户端来请求-百度翻译-接口">使用 Guzzle 的 HTTP 客户端来请求 <a href="http://api.fanyi.baidu.com/api/trans/product/apidoc">百度翻译</a> 接口。</h4>

<h3 id="队列任务">队列任务</h3>
<h4 id="redis">Redis</h4>
<ul>
  <li>
    <p>生成队列任务</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan make:job TranslateSlug
</code></pre></div>    </div>
  </li>
  <li>
    <p>监听 Topic 的 saved 事件，触发后将任务推送到队列</p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">function</span> <span class="n">saved</span><span class="p">(</span><span class="kt">Topic</span> <span class="nv">$topic</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="c1">// 如 slug 字段无内容，即使用翻译器对 title 进行翻译</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$topic</span><span class="o">-&gt;</span><span class="n">slug</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">// 推送任务到队列</span>
          <span class="nf">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nc">TranslateSlug</span><span class="p">(</span><span class="nv">$topic</span><span class="p">));</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="队列监控-horizon">队列监控 Horizon</h4>
<p>Horizon 是 Laravel 生态圈里的一员，为 Laravel Redis 队列提供了一个漂亮的仪表板，允许我们很方便地查看和管理 Redis 队列任务执行的情况。</p>

<hr />
<h2 id="模型监听">模型监听</h2>
<h3 id="模型观察器监控-eloquent-模型事件">模型观察器监控 Eloquent 模型事件</h3>

<hr />
<h2 id="多角色权限管理">多角色权限管理</h2>
<h3 id="角色是用户在站点中的身份很多时候与站点权限相关联">角色是用户在站点中的身份，很多时候与站点权限相关联</h3>
<p>在本项目中，有以下几个角色，权限由低到高：</p>
<ul>
  <li>游客 —— 没有登录的用户</li>
  <li>用户 —— 登录用户</li>
  <li>管理员 —— 社区内容管理</li>
  <li>站长 —— 权限最高的用户角色</li>
</ul>

<h3 id="权限管理扩展包-laravel-permission">权限管理扩展包 Laravel-permission</h3>
<p>数据表结构：</p>
<ul>
  <li>roles —— 角色的模型表；</li>
  <li>permissions —— 权限的模型表；</li>
  <li>model_has_roles —— 模型与角色的关联表，用户拥有什么角色在此表中定义，一个用户能拥有多个角色；</li>
  <li>role_has_permissions —— 角色拥有的权限关联表，如管理员拥有查看后台的权限都是在此表定义，一个角色能拥有多个权限；</li>
  <li>model_has_permissions —— 模型与权限关联表，一个模型能拥有多个权限。</li>
</ul>

<h3 id="管理后台扩展包-laravel-administrator">管理后台扩展包 Laravel Administrator</h3>
<p>这是一个使用「配置信息」来快速生成管理员后台的开发理念，几分钟内就能拥有一个可用的后台。</p>

<hr />
<h2 id="计划任务">计划任务</h2>
<p>通过 Laravel 命令调度器在 Laravel 中对命令调度进行清晰流畅的定义，这样只需要在服务器上增加一条 Cron 项目即可。调度在 app/Console/Kernel.php 文件的 schedule 方法中定义，还能受到版本控制。</p>
<h3 id="修改系统的-cron-计划任务配置信息">修改系统的 Cron 计划任务配置信息</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">EDITOR</span><span class="o">=</span>vim <span class="o">&amp;&amp;</span> crontab <span class="nt">-e</span>
</code></pre></div></div>

<p>增加下面这行：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* * * * * php /home/vagrant/Code/larabbs/artisan schedule:run &gt;&gt; /dev/null 2&gt;&amp;1
</code></pre></div></div>

<p>系统的 Cron 已经设定好了，现在 Cron 软件将会每分钟调用一次 Laravel 命令调度器，当 <code class="language-plaintext highlighter-rouge">schedule:run</code> 命令执行时， Laravel 会评估你的计划任务并运行预定任务。</p>

<p>注册调度任务<br />
<code class="language-plaintext highlighter-rouge">app/Console/Kernel.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">function</span> <span class="n">schedule</span><span class="p">(</span><span class="kt">Schedule</span> <span class="nv">$schedule</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 一小时执行一次『活跃用户』数据生成的命令</span>
        <span class="nv">$schedule</span><span class="o">-&gt;</span><span class="nf">command</span><span class="p">(</span><span class="s1">'larabbs:calculate-active-user'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">hourly</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>

<hr />
<h2 id="用户最后登录时间">用户最后登录时间</h2>
<h3 id="基本思路">基本思路：</h3>
<ol>
  <li>记录 - 通过中间件过滤用户所有请求，记录用户访问时间到 Redis 按日期区分的哈希表；</li>
  <li>同步 - 新建命令，计划任务每天运行一次此命令，将昨日哈希表里的数据同步到数据库中，并删除；</li>
  <li>读取 - 优先读取当日哈希表里 Redis 里的数据，无数据则使用数据库中的值。</li>
</ol>

<h3 id="自定义-middleware-中间件">自定义 Middleware 中间件</h3>
<h4 id="利用-laravel-中间件-功能来实现用户访问时间的记录">利用 <a href="https://learnku.com/docs/laravel/7.x/middleware">Laravel 中间件</a> 功能来实现用户访问时间的记录。</h4>
<p>创建中间件</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan make:middleware RecordLastActivedTime
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">app/Http/Middleware/RecordLastActivedTime.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="kt">Closure</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 如果是登录用户的话</span>
        <span class="k">if</span> <span class="p">(</span><span class="nc">Auth</span><span class="o">::</span><span class="nf">check</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// 记录最后登录时间</span>
            <span class="nc">Auth</span><span class="o">::</span><span class="nf">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recordLastActivedAt</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>注册中间件 <code class="language-plaintext highlighter-rouge">app/Http/Kernel.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="nv">$middlewareGroups</span> <span class="o">=</span> <span class="p">[</span>

        <span class="c1">// Web 中间件组，应用于 routes/web.php 路由文件，</span>
        <span class="c1">// 在 RouteServiceProvider 中设定</span>
        <span class="s1">'web'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="mf">...</span>
            <span class="c1">// 记录用户最后活跃时间</span>
            <span class="err">\</span><span class="nc">App\Http\Middleware\RecordLastActivedTime</span><span class="o">::</span><span class="n">class</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="mf">...</span>
    <span class="p">];</span>
</code></pre></div></div>

<h3 id="自定义-artisan-命令">自定义 Artisan 命令</h3>
<h4 id="新建命令">新建命令</h4>
<p>终端中执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan make:command SyncUserActivedAt <span class="nt">--command</span><span class="o">=</span>larabbs:sync-user-actived-at
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">app/Console/Commands/SyncUserActivedAt.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="nv">$signature</span> <span class="o">=</span> <span class="s1">'larabbs:sync-user-actived-at'</span><span class="p">;</span>
<span class="k">protected</span> <span class="nv">$description</span> <span class="o">=</span> <span class="s1">'将用户最后登录时间从 Redis 同步到数据库中'</span><span class="p">;</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">handle</span><span class="p">(</span><span class="kt">User</span> <span class="nv">$user</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="nf">syncUserActivedAt</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">info</span><span class="p">(</span><span class="s2">"同步成功！"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="执行命令">执行命令</h4>
<p>终端中执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan larabbs:sync-user-actived-at
</code></pre></div></div>

<h4 id="每天零时-0000-自动对数据进行同步通过-laravel-任务调度实现此功能">每天零时 00:00 自动对数据进行同步。通过 Laravel 任务调度实现此功能。</h4>
<p><code class="language-plaintext highlighter-rouge">app/Console/Kernel.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">function</span> <span class="n">schedule</span><span class="p">(</span><span class="kt">Schedule</span> <span class="nv">$schedule</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 每日零时执行一次</span>
        <span class="nv">$schedule</span><span class="o">-&gt;</span><span class="nf">command</span><span class="p">(</span><span class="s1">'larabbs:sync-user-actived-at'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">dailyAt</span><span class="p">(</span><span class="s1">'00:00'</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<hr />
<h2 id="消息通知">消息通知</h2>
<h3 id="laravel-的消息通知系统">Laravel 的消息通知系统</h3>
<h4 id="通知频道有数据库邮件短信通过-nexmo以及-slack">通知频道有数据库、邮件、短信（通过 Nexmo）以及 Slack。</h4>
<h4 id="当-topic-有新-reply-时通知作者">当 Topic 有新 reply 时，通知作者</h4>
<ol>
  <li>准备数据库</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan notifications:table

php artisan migrate
</code></pre></div></div>

<p>并在用户表加入消息计数字段。</p>

<ol>
  <li>生成通知类</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php artisan make:notification TopicReplied
</code></pre></div></div>

<ol>
  <li>在模型监听器中监听 reply 的 created 事件，触发后使用 notify() 发送通知</li>
</ol>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 通知话题作者有新的评论</span>
<span class="nv">$reply</span><span class="o">-&gt;</span><span class="n">topic</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">-&gt;</span><span class="nf">notify</span><span class="p">(</span><span class="k">new</span> <span class="nc">TopicReplied</span><span class="p">(</span><span class="nv">$reply</span><span class="p">));</span>
</code></pre></div></div>



  </div>


  <div id="menuIndex" class="sidenav">
    <div class="myinfo"><center>
      <div id="avatarHolder" class="avatar circle" style="width: 0px; height: 0px; box-shadow: none; margin-bottom: 20px;"></div>
      <a href="/index.html" title="Homepage"><i class="icon-home icon-large"></i> Home</a>
      <a href=""><i class="icon-linkedin-sign icon-large"></i> Profile</a>
      <a href="https://github.com/Catname"><i class="icon-github icon-large"></i> Code</a>
      <a href="mailto:tomcath@foxmail.com"><i class="icon-envelope icon-large"></i> Mail</a>
    </center></div>
    <div id="menu"></div>
  </div>
</div>

<script src="/js/post.js" type="text/javascript"></script>

</body>
</html>
